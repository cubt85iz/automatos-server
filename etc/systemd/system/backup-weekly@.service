[Unit]
Description=Service for weekly container volume backups

[Service]
Type=oneshot
EnvironmentFile="/etc/containers/config/%i.env"
EnvironmentFile="/etc/dotenv/host_secrets.env"
Environment=TIMESTAMP=$(date +%%Y_%%m_%%d-%%H_%%M_%%S)
ExecStartPre=/usr/bin/create-snapshot "$DATASET" "weekly" "n" "$TIMESTAMP"
ExecStart=/usr/bin/backup-snapshot "$DATASET@$TIMESTAMP-weekly" "$BACKUP_PATH" "$BACKUP_KEY"
ExecStartPost=/usr/bin/upload-to-b2 "$B2_ACCOUNT" "$B2_KEY" "$BACKUP_PATH" "%H-$DATASET"
ExecStartPost=/usr/bin/prune-snapshots "$DATASET" "weekly" "n" "$KEEP_WEEKLY"
ExecStartPost=/usr/bin/curl -fsS -m 10 --retry 5 -o /dev/null "$BACKUP_MONITOR_URL"
