#!/usr/bin/env bash

set -eou pipefail

ACCOUNT_ID=$1
ACCOUNT_KEY=$2
BACKUP_PATH=$3
BUCKET=$4

function rclone {
  command rclone --b2-account="$ACCOUNT_ID" --b2-key="$ACCOUNT_KEY" "$@"
}

if [ -n "$ACCOUNT_ID" ] && [ -n "$ACCOUNT_KEY" ]; then
  if [ -n "$BACKUP_PATH" ] && [ -d "$BACKUP_PATH" ]; then
    if [ -n "$BUCKET" ]; then 
      if ! rclone ls "$BUCKET"; then
        rclone mkdir "$BUCKET"
      fi

      rclone sync "$BACKUP_PATH" "$BUCKET"
    else
      echo "Please provide a bucket name."
      exit 1
    fi
  else
    echo "Please provide a valid backup path."
    exit 1
  fi
else
  echo "Please provide account credentials for Backblaze B2."
  exit 1
fi