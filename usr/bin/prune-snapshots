#!/usr/bin/env bash

set -euo pipefail

DATASET=$1
TYPE=$2
RECURSIVE=${3:-n}
COUNT=$4

if [ -n "$DATASET" ] && zfs list -H -t filesystem "$DATASET"; then
  if [ -n "$TYPE" ]; then
    if [ -n "$COUNT" ]; then
      SNAPSHOT_COUNT=$(zfs list -H -t snapshot "$DATASET" | grep -c "$TYPE")
      if [ "$SNAPSHOT_COUNT" -gt "$COUNT" ]; then
        OLD_SNAPSHOT_COUNT=$((SNAPSHOT_COUNT - COUNT))
        echo "Pruning $OLD_SNAPSHOT_COUNT $TYPE snapshots."

        mapfile -t OLD_SNAPSHOTS < <(zfs list -H -t snapshot "$DATASET" | grep "$TYPE" | head -n "$OLD_SNAPSHOT_COUNT")
        for SNAPSHOT in "${OLD_SNAPSHOTS[@]}"; do
          if [ -n "$RECURSIVE" ]; then
            case $RECURSIVE in
              Y|y|yes|1)
                zfs destroy -r "$SNAPSHOT"
                ;;
              *)
                zfs destroy "$SNAPSHOT"
                ;;
            esac
          fi
        done
      fi
    else
      echo "Retention policy undefined for snapshot type."
      exit 1
    fi
  else
    echo "Please provide a valid snapshot type. Valid values are daily, weekly, monthly, yearly."
    exit 1
  fi
else
  echo "Please provide a valid ZFS dataset."
  exit 1
fi
